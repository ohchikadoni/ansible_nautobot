---
- name: Backup Aruba Switch Configuration
  hosts: localhost
  gather_facts: no
  vars:
    ansible_user: admin       # Benutzername für SSH
    ansible_password: admin   # Passwort für SSH
    ansible_network_os: aruba  # Aruba OS
    ansible_connection: network_cli  # SSH-Verbindung
    ansible_ssh_extra_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"  
    ansible_command_timeout: 60 

  tasks:
    - name: Get all devices from Nautobot
      uri:
        url: "http://10.10.10.101:8080/api/dcim/devices/"
        method: GET
        return_content: yes
        headers:
          Authorization: "Token 3a28f76fe9d03a5467e955e71cc5b37c6a047b18"
          Accept: "application/json; indent=4"
      register: nautobot_response

    - name: Filter devices with configuration enabled
      set_fact:
        enable_configuration: "{{ nautobot_response.json.results | selectattr('custom_fields.enable_configuration', 'equalto', true) | list }}"

    - name: Fetch primary IPv4 address for each configuration-enabled device
      uri:
        url: "{{ item.primary_ip4.url }}"
        method: GET
        return_content: yes
        headers:
          Authorization: "Token  3a28f76fe9d03a5467e955e71cc5b37c6a047b18"
          Accept: "application/json; indent=4"
      loop: "{{ enable_configuration }}"
      when: item.primary_ip4 is defined
      register: ip_responses

    - name: Merge IPs with devices
      set_fact:
        devices_with_ips: "{{ enable_configuration | zip(ip_responses.results | map(attribute='json.address')) | list }}"

    
    - name: Fetch interfaces for each enabled device
      uri:
        url: "http://10.10.10.101:8080/api/dcim/interfaces/?device={{ item.0.name }}"
        method: GET
        headers:
          Authorization: "Token 3a28f76fe9d03a5467e955e71cc5b37c6a047b18"
          Accept: "application/json; indent=4"
        return_content: yes
      loop: "{{ devices_with_ips }}"
      register: interfaces_info


    - name: Merge interface data with devices
      set_fact:
        devices_with_data: "{{ devices_with_ips | zip(interfaces_info.results | map(attribute='json.results')) | list }}"

