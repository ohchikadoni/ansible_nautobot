---
- name: Get devices from Nautobot and Backup Switch Configuration
  hosts: localhost
  gather_facts: no
  vars:
    ansible_command_timeout: 60
    ansible_user: admin
    ansible_password: admin
    ansible_network_os: aruba 
    ansible_connection: network_cli
    ansible_ssh_extra_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"

  tasks:
    - name: Get all devices from Nautobot
      uri:
        url: "http://10.10.10.101:8080/api/dcim/devices/"
        method: GET
        return_content: yes
        headers:
          Authorization: "Token 3a28f76fe9d03a5467e955e71cc5b37c6a047b18"
          Accept: "application/json; indent=4"
        return_content: yes
      register: nautobot_response

    - name: Filter devices with backup enabled
      set_fact:
        backup_devices: "{{ nautobot_response.json.results | selectattr('custom_fields.backup_state', 'equalto', true) | list }}"

    - name: Fetch primary IPv4 address for each backup-enabled device
      uri:
        url: "{{ item.primary_ip4.url }}"
        method: GET
        return_content: yes
        headers:
          Authorization: "Token 3a28f76fe9d03a5467e955e71cc5b37c6a047b18"
          Accept: "application/json; indent=4"
      loop: "{{ backup_devices }}"
      when: item.primary_ip4 is defined
      register: ip_responses

    - name: Merge IPs with devices
      set_fact:
        devices_with_ips: "{{ backup_devices | zip(ip_responses.results | map(attribute='json.address')) | list }}"

    - name: Display hostnames and actual primary IPv4 addresses
      debug:
        msg: "Hostname: {{ item.0.name }}, IP: {{ item.1 }}"
      loop: "{{ devices_with_ips }}" 

    - name: Accept SSH key automatically
      shell: "ssh-keyscan -H {{ item.1.split('/')[0] }} >> ~/.ssh/known_hosts"
      loop: "{{ devices_with_ips }}"
      delegate_to: localhost

    - name: Set terminal length to 0 (disable pagination)
      aruba_command:
        commands:
          - terminal length 0
      delegate_to: "{{ item.primary_ip4.address.split('/')[0] }}"
      loop: "{{ backup_devices }}"
      
    - name: Fetch running configuration from Aruba device
      aruba_command:
        commands:
          - show running-config
      register: running_config
      delegate_to: "{{ item.primary_ip4.address.split('/')[0] }}"
      loop: "{{ backup_devices }}"

    - name: Save configuration to file
      copy:
        content: "{{ running_config.stdout[0] }}"
        dest: "{{ item.name }}.conf"
      loop: "{{ backup_devices }}"
